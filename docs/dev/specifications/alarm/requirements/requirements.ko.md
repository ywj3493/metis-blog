# Alarm 도메인 요구사항

이 문서는 Alarm 도메인의 기능 요구사항을 정의합니다. Alarm 도메인은 다양한 블로그 이벤트에 대한 이메일 알림 전송을 처리합니다.

## 개요

Alarm 도메인은 특정 이벤트가 발생했을 때 블로그 소유자에게 이메일 알림을 전송하는 백그라운드 서비스입니다. 현재는 방명록 제출에 대한 알림을 지원하지만, 다른 이벤트 유형으로 확장 가능하도록 설계되어 있습니다.

## 기능 요구사항

### FR-ALARM-001: 이메일 알림 서비스

**설명**: 다양한 블로그 이벤트에 의해 트리거될 수 있는 중앙 집중식 이메일 알림 서비스를 제공합니다.

**수용 기준**:
- API 엔드포인트를 통해 알림 요청 수락
- 필수 필드 검증 (from, subject, message)
- Gmail SMTP를 통한 이메일 전송
- 성공/실패 상태 반환
- 비동기 처리 (호출자에게 논블로킹)

**기술 상세**:
- SMTP 호스트: `smtp.gmail.com`
- SMTP 포트: `465` (SSL)
- 인증: Gmail 앱 비밀번호
- 수신자: 블로그 소유자 (환경 변수로 설정)

**API 엔드포인트**: `POST /api/alarm`

**관련 컴포넌트**:
- `src/app/api/alarm/route.ts`
- `src/features/alarm/model/index.ts`

---

### FR-ALARM-002: 방명록 알림 트리거

**설명**: 새로운 방명록 항목이 제출되면 자동으로 블로그 소유자에게 알림을 보냅니다.

**수용 기준**:
- 성공적인 방명록 제출 후 알림 트리거
- 작성자 이름, 메시지 내용, 공개 상태 포함
- Fire-and-forget 패턴 (폼 제출을 차단하지 않음)
- 알림 실패 시 우아하게 처리 (로깅하되 제출 실패시키지 않음)

**알림 내용**:
| 필드 | 소스 |
|-----|------|
| From | "guestbook@blog.com" (또는 설정 가능) |
| Subject | `새로운 방명록: ${authorName}` |
| Message | 작성자 이름, 내용, 공개/비공개 상태 |

**트리거 지점**: 성공적인 API 응답 후 `GuestbookForm.onSubmit()`

**관련 컴포넌트**:
- `src/features/guestbooks/ui/guestbook-form.tsx`

---

## 데이터 모델

### EmailForm 타입

```typescript
type EmailForm = {
  from: string;     // 발신자 식별자 (이메일 또는 이름)
  subject: string;  // 이메일 제목
  message: string;  // 이메일 본문 (HTML 지원)
};
```

### 이메일 템플릿 구조

```typescript
// 생성되는 이메일 HTML
{
  to: process.env.AUTH_USER,    // 블로그 소유자 이메일
  subject: `[BLOG] ${subject}`, // 필터링을 위한 접두사
  from: from,
  html: `
    <h1>${subject}</h1>
    <div>${message}</div>
    <br />
    <p>보낸사람: ${from}</p>
  `
}
```

---

## 비기능 요구사항

### NFR-ALARM-001: 신뢰성

- 이메일 전송 성공률 > 99%
- 실패한 전송은 디버깅을 위해 로깅
- 현재 재시도 메커니즘 없음 (fire-and-forget)

### NFR-ALARM-002: 성능

- 이메일 전송이 사용자 상호작용을 차단하지 않음
- API 응답 시간 < 5초 (일반적인 SMTP 핸드셰이크)
- 호출자 관점에서 비동기 처리

### NFR-ALARM-003: 보안

- SMTP 자격 증명은 환경 변수에 저장
- Gmail 앱 비밀번호 (일반 비밀번호 아님)
- 이메일 제목에 민감한 데이터 없음 (전송 보안)

### NFR-ALARM-004: 모니터링

- 이메일 실패 시 오류 로깅
- 현재 메트릭 수집 없음
- 반복적인 실패에 대한 알림 추가 고려

---

## 의존성

### 외부 서비스

| 서비스 | 목적 | 설정 |
|-------|-----|------|
| Gmail SMTP | 이메일 전송 | `AUTH_USER`, `AUTH_PASS` |

### 내부 모듈

| 모듈 | 목적 |
|-----|------|
| `nodemailer` | SMTP 클라이언트 라이브러리 |
| `zod` | 요청 유효성 검증 |

---

## 오류 처리

### 유효성 검증 오류

| 오류 | HTTP 상태 | 응답 |
|-----|----------|------|
| 필수 필드 누락 | 400 | "보내는이, 제목, 내용은 문자열만 가능합니다." |
| 잘못된 타입 | 400 | "보내는이, 제목, 내용은 문자열만 가능합니다." |

### 서버 오류

| 오류 | HTTP 상태 | 응답 |
|-----|----------|------|
| SMTP 연결 실패 | 500 | "메일 전송에 실패함" |
| 인증 실패 | 500 | "메일 전송에 실패함" |
| 수신자 거부 | 500 | "메일 전송에 실패함" |

---

## 환경 설정

### 필수 변수

```bash
# Gmail SMTP 인증
AUTH_USER=your@gmail.com           # Gmail 주소 (수신자로도 사용)
AUTH_PASS=xxxx xxxx xxxx xxxx      # Gmail 앱 비밀번호 (16자)
```

### Gmail 앱 비밀번호 설정

1. Gmail 계정에서 2단계 인증 활성화
2. Google 계정 → 보안 → 앱 비밀번호로 이동
3. "메일"에 대한 새 앱 비밀번호 생성
4. 생성된 비밀번호 (공백 포함)를 `AUTH_PASS`로 사용

---

## 범위 외

- 이메일 큐잉 및 재시도 메커니즘
- 다중 수신자 지원
- 이메일 템플릿 관리
- 전송 추적/수신 확인
- 구독 해제 기능
- 속도 제한
